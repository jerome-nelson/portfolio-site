version: '3.7'
services:
  api:
    image: golang:latest
    command: sh -c "go get -d -v ./... && go run main.go -serve=${API_PORT} -dburl=mongodb://${DB_USER}:${DB_PASS}@${DB_HOST} -dbname=${DB_NAME}"
    environment:
      - GOROOT=/usr/local/go
      - GOPATH=/go
      - DBNAME=${DB_NAME}
      - DBURL=mongodb://${DB_USER}:${DB_PASS}@${DB_HOST}
      - SERVE=${API_PORT}
    ports:
      - "${API_PORT}:${API_PORT}"
    volumes:
        - "./go/src:/go/src"
    working_dir: "/go/src"
  db-seed:
    command: bash -c "/scripts/wait-for.sh db:${DB_PORT} -- /scripts/generateSeed.sh"
    depends_on:
      - db
    image: node:latest
    working_dir: "/scripts/generator"
    volumes:
      - "./mongo/scripts:/scripts"
  db:
    image: mongo:3.4.22-xenial
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DB_ROOT_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${DB_ROOT_PASS}
      - DB_PASS=${DB_PASS}
      - DB_USER=${DB_USER}
    ports:
      - "${DB_PORT}:${DB_PORT}"
    volumes:
      - "./mongo/scripts:/mongo"
